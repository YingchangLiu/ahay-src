\published{Geophysical Journal International, 211, 1478-1493, (2017)}

\title{Recursive integral time extrapolation of elastic waves using low-rank symbol approximation}

\author{Junzhe Sun$^*$\footnotemark[1], Sergey Fomel\footnotemark[1], Yanadet Sripanich\footnotemark[1] and Paul Fowler\footnotemark[2]}
\maketitle

\address{
\footnotemark[1]Bureau of Economic Geology \\
John A. and Katherine G. Jackson School of Geosciences \\
The University of Texas at Austin \\
University Station, Box X \\
Austin, TX 78713-8924 \\
\footnotemark[2]Fowler Geophysical Consulting \\
1040 S. Florence St. \\
Denver, CO 80247
}

\lefthead{Sun, Fomel, Sripanich \& Fowler}
\righthead{Low-rank elastic wave extrapolation}

\begin{abstract}
    Conventional solutions of elastic wave equations rely on inaccurate finite-difference approximations of the time derivative, which result in strict dispersion and stability conditions and limitations. In this work, we derive a general solution to the elastic anisotropic wave equation, in the form of a Fourier Integral Operator (FIO). The proposed method is a generalization of the previously developed recursive integral time extrapolation operators from acoustic to elastic media, and can accurately propagate waves in time using the form of the analytical solution in homogeneous media. The formulation is closely connected to elastic wave mode decomposition, and can be applied to the most general anisotropic medium. The numerical calculation of the FIO makes use of a low-rank approximation to enable highly accurate and stable wave extrapolations. We present numerical examples including wave propagation in $3$D heterogeneous orthorhombic and triclinic models.
\end{abstract}

\section{Introduction}
Elastic wave extrapolation honors elastic effects such as wave mode conversions, and provides reliable amplitude information which is crucial in seismic imaging of the subsurface. With advances of high-performance computing, seismic processing algorithms such as reverse-time migration (RTM) and full waveform inversion (FWI) based on elastic kernels are becoming more affordable \cite[]{lu10,denes14}. The most widely used method to solve elastic wave equations involves finite-difference approximations of both spatial and temporal derivatives \cite[]{virieux84,virieux86,etgen87,levander88,bernth10,bernth11}. The pseudo\-spectral method \cite[]{kosloff84,reshef88,psbook} provides accurate calculation of spatial derivatives, but still requires small time steps to avoid temporal dispersion. The numerical accuracy of temporal differentiation can be improved by employing higher-order Taylor expansions in the explicit case \cite[]{dablain86,crase90} and Pad\'{e} expansions in the implicit case \cite[]{chuthesis,liu09}. When implemented using coupled first-order particle velocity-stress systems, these methods usually require to use staggered grids to correctly center first-order differences of different model parameters \cite[]{ozdenvar96,correa02,bernth10}. Recently, several methods have been introduced for stable and dispersion-free time extrapolation of scalar wavefields using the analytical solution of the acoustic wave equation in homogeneous media \cite[]{tal-ezer86,tal-ezer87,tabei02,etgen09,zhang09,pestana10,chu10,lowrank,song13,fang14,sun16}. \cite{rite} provide a review of existing operators of such nature and refer to them as \emph{recursive integral time extrapolation}. \cite{chu11} and \cite{firouzi12} extend this approach to elastic wave extrapolation in isotropic media.

To mitigate cross-talk between P- and S-waves, it is often necessary to decouple different wave modes prior to imaging. In isotropic media, wave-mode separation can be achieved using the divergence and curl operators \cite[]{aki}. \cite{joejohn} implement wave-mode separation in anisotropic media by projecting the vector wavefield onto the polarization directions defined by the Christoffel equation. \cite{yanvti,yantti} implement wave-mode separation in vertical transversely isotropic (VTI) and tilted transverse isotropic (TTI) media by introducing space-domain non-stationary filters to handle spatial heterogeneity, and improve the efficiency using the idea of phase-shift plus interpolation \cite[]{yanpspi}. \cite{zm} further investigate wavefield vector decomposition method in the wavenumber domain and apply it to VTI media. \cite{chengfomel} formulate the wave-mode separation and decomposition operators in heterogeneous media as Fourier Integral Operators (FIOs) and efficiently apply them using the low-rank approximation \cite[]{lowrank}. \cite{sripanich15} extend the low-rank decomposition operator to wave-mode decomposition in orthorhombic media.

Conventionally, wave-mode decomposition and wave extrapolation are considered as two separated steps. \cite{hou14} and \cite{cheng14,cheng16} combine these two steps into a single FIO, which can be implemented by low-rank approximation. These methods are based on the assumption that the medium properties are sufficiently smooth so that their spatial derivatives can be neglected. However, the Earth model can be strongly heterogeneous and contain discontinuities, e.g., at salt/sediment boundaries. In such cases, the assumption about the smoothness of the Earth model is no longer valid and could lead to inaccurate calculation of polarization directions. More importantly, simultaneous wave extrapolation and wave-mode separation based on such an assumption may fail to provide reliable phase and amplitude information.

In this paper, we introduce a general framework for elastic wave extrapolation in strongly heterogeneous and anisotropic media without the assumption of the smoothness of the medium. The proposed method uses FIOs which allow accurate and stable wave extrapolation to be performed without explicit wave-mode separation. The proposed formulation reveals a simple connection between wave-mode decomposition and wave extrapolation through matrix exponentials. We also show that it is not necessary to explicitly decompose the wavefield into separate wave modes in order to apply recursive integral operators. We first derive one-step elastic wave extrapolation in homogeneous and smooth media motivated by one-step acoustic wave extrapolation \cite[]{zhang09,sun16}. In one-step extrapolation of elastic waves, only positive or negative frequency components are propagated, naturally providing the direction information that is useful for efficient wavefield up-down separation and angle gathers computation during imaging \cite[]{shen15,hu16,sun16}. We also construct the corresponding two-step scheme which uses only a real-valued vector wavefield. We draw connections of the proposed method to simultaneous propagation of decoupled elastic wave modes. Next, we show that to accurately model wave propagation in strongly heterogeneous media, spatial gradients of stiffnesses need to be included in the Christoffel matrix, leading to complex eigenvalues and polarization directions. Efficient calculation of the proposed FIOs in heterogeneous media is enabled by approximating the wave extrapolation matrix symbol with a low-rank decomposition. Our numerical examples demonstrate that the proposed method is stable and free of dispersion artifacts and therefore is suitable for accurate elastic RTM and FWI in (strongly) heterogeneous anisotropic media.

\section{Theory}

\subsection{A Generic Wave Equation}
Following the notation of \cite{rite}, a generic linear second-order in time wave equation can be expressed in the following form
\begin{equation}
\label{eq:we}
\left( \frac{\partial^2}{\partial t^2} + \A \right) \uu(\x,t) = 0 \;,
\end{equation}
where $\uu$ is the wavefield, $\x$ is the spatial location, $t$ is time, and $\A$ is the a matrix operator containing material parameters and spatial derivative operators. Equation~\ref{eq:we} can also be expressed using the first-order system
\begin{equation}
\label{eq:we1st}
\frac{\partial}{\partial t} \begin{bmatrix}   \uu \\ \uu_t \end{bmatrix} 
= \begin{bmatrix}   0 & \I \\ -\A & 0 \end{bmatrix} \begin{bmatrix}   \uu \\ \uu_t \end{bmatrix} \equiv \B \begin{bmatrix}   \uu \\ \uu_t \end{bmatrix} \;,
% \equiv \B \uu
\end{equation}
where $\uu_t \equiv \partial \uu/\partial t$. The solution of equation~\ref{eq:we1st} can be formulated using the definition of the matrix exponential:
\begin{equation}
\label{eq:sol-we1st}
\begin{bmatrix}   \uu(t) \\ \uu_t(t) \end{bmatrix} = e^{\B t} \begin{bmatrix}   \uu(0) \\ \uu_t(0) \end{bmatrix}
%\uu(t) = e^{\B t} \uu(0) \;.
\end{equation}
Defining $\Fi \equiv \sqrt{\A}$, the eigenvalue decomposition of $\B$ can be written as \cite[]{rite}
\begin{equation}
\B = \S \La \S^{-1} \;,
\end{equation}
where 
\begin{eqnarray}
&\S = \frac{1}{\sqrt{2}} \begin{bmatrix} \I & \I \\ i\Fi & -i\Fi \end{bmatrix} \;, \\
&\S^{-1} = \frac{1}{\sqrt{2}} \begin{bmatrix} \I & -i\Fi^{-1} \\ \I & i\Fi^{-1} \end{bmatrix} \;, \nonumber \\
&\La = \begin{bmatrix} i\Fi & 0 \\ 0 & -i\Fi \end{bmatrix} \;. \nonumber
\end{eqnarray}

The solution to the first-order system~\ref{eq:sol-we1st} can now be written as
\begin{equation}
\begin{bmatrix} \uu(t) \\ \uu_t(t) \end{bmatrix} = \S e^{\La t} \S^{-1} \begin{bmatrix} \uu(0) \\ \uu_t(0) \end{bmatrix} \;.
\end{equation}
To simplify the system, we can define the analytical wavefield
\begin{equation}
\begin{bmatrix} \hat{\uu}_1(t) \\ \hat{\uu}_2(t) \end{bmatrix} = \S^{-1} \begin{bmatrix} \uu(t) \\ \uu_t(t) \end{bmatrix} = \frac{1}{\sqrt{2}}  \begin{bmatrix}  \uu(t)-i\Fi^{-1}\uu_t(t) \\ \uu(t)+i\Fi^{-1}\uu_t(t) \end{bmatrix} \;.
\end{equation}
The solution to equation~\ref{eq:we} finally takes the form
\begin{equation}
    \label{eq:osteps}
\begin{bmatrix} \hat{\uu}_1(t) \\ \hat{\uu}_2(t) \end{bmatrix} = e^{\La t} \begin{bmatrix} \hat{\uu}_1(0) \\ \hat{\uu}_2(0) \end{bmatrix} = \begin{bmatrix} e^{i\Fi t} & 0 \\ 0 & e^{-i\Fi t} \end{bmatrix} \begin{bmatrix} \hat{\uu}_1(0) \\ \hat{\uu}_2(0) \end{bmatrix} \;.
\end{equation}

Selecting the first of the two decoupled solutions of equation~\ref{eq:osteps} leads to a time extrapolation operator
\begin{equation}
\label{eq:os}
\hat{\uu}(\x,t+\Delta t) = e^{i\Fi\Delta t} \hat{\uu}(\x,t) \;,
\end{equation}
where $\hat{\uu} =(\uu-i\Fi^{-1}\uu_t)/\sqrt{2}$.

For acoustic isotropic constant-density wave equations for pressure waves, $\A = v^2|\kk|^2$ where $v$ is velocity and $|\kk|^2$ is the Laplacian operator.  This corresponds to the one-step extrapolation method proposed by \cite[]{zhang09}.

The wavefield $\hat{\uu}$ is an analytical signal, with its imaginary part being the Hilbert transform of its real part \cite[]{zhang09}. To see this, we can perform Hilbert transform to the real-valued wavefield $\uu$ in the frequency domain, and use the dispersion relation $\omega^2 = \Phi^2$ and derivative property of Fourier Transform
\newcommand{\sign}{\text{sign}}
\begin{equation}
    \label{eq:hilb}
    \uu(t) \xrightarrow{\mathscr{F}} \uu(\omega) \xrightarrow{\mathscr{H}} i\,\sign(\omega) \uu(\omega) = \frac{i\,\omega}{|\omega|} \uu(\omega) = \frac{i\,\omega}{\Fi} \uu(\omega) \xrightarrow{\mathscr{F}^{-1}} = \Fi^{-1}\uu_t(t) \;,
\end{equation}
where $\mathscr{F}$ and $\mathscr{F}^{-1}$ denotes forward and inverse Fourier transform in time. The output corresponds to the imaginary part of analytical wavefield $\hat{\uu}$.

\subsection{Homogeneous Media}
We first assume homogeneous model properties and investigate the form of time stepping solutions in general elastic media. For elastic anisotropic wave equations, the matrix operator $\A$ corresponds to the spatial Fourier transform of the matrix $-\Ga/\rho = -\D\C\D^\intercal/\rho$, where $\Ga$ is the Christoffel matrix, $\rho$ is density, $\C$ is the elastic stiffness tensor expressed in Voigt notation as a $6\times6$ matrix, and $\D$ is the derivative matrix operator give by
\begin{equation}
  \D=
  \begin{bmatrix}
    \partial_x & 0 & 0 & 0 & \partial_z & \partial_y \\
    0 & \partial_y & 0 & \partial_z & 0 & \partial_x \\
    0 & 0 & \partial_z & \partial_y & \partial_x & 0
  \end{bmatrix} \;.
\end{equation}

In the Fourier (wavenumber) domain, the homogeneous $\A$ takes the form $\tilde{\Ga}/\rho$ after $i^2$ cancels the negative sign, i.e., $-\Ga \xrightarrow{\mathscr{F}} \tilde{\Ga}$. 
For example, the Christoffel matrix $\tilde{\Ga}$ in the case of orthorhombic anisotropy takes the form:
\begin{equation}
  \label{eq:chris}
  \tilde{\Ga} = 
  \begin{bmatrix}
    C_{11}k_x^2+C_{66}k_y^2+C_{55}k_z^2 & (C_{12}+C_{66})k_xk_y & (C_{13}+C_{55})k_xk_z \\
    (C_{12}+C_{66})k_xk_y & C_{66}k_x^2+C_{22}k_y^2+C_{44}k_z^2 & (C_{23}+C_{44})k_yk_z  \\
    (C_{13}+C_{55})k_xk_z & (C_{23}+C_{44})k_yk_z & C_{55}k_x^2+C_{44}k_y^2+C_{33}k_z^2
  \end{bmatrix} \;.
\end{equation}

The square root matrix $\Fi$ is analogous to the phase function in the acoustic case, and corresponds to the angular frequency $\omega$ according to the dispersion relation. Since the matrix $\tilde{\Ga}$ is symmetric positive definite (SPD), it can be diagonalized with its eigenvalues corresponding to the square of phase velocity of separate wave modes and its orthogonal eigenvectors corresponding to the polarization directions:
\begin{eqnarray}
    \label{eq:chris-eigen}
\A = \frac{\tilde{\Ga}}{\rho} &=& \mathbf{Q} \mathbf{V} \mathbf{Q}^\intercal \\ \nonumber 
&=& \begin{bmatrix} \ba_p & \ba_{s1} & \ba_{s2}\end{bmatrix} \begin{bmatrix} v_p^2 k^2 & 0 & 0 \\ 0 & v_{s1}^2 k^2 & 0 \\ 0 & 0 & v_{s2}^2 k^2 \end{bmatrix} \begin{bmatrix} \ba_p^\intercal \\ \ba_{s1}^\intercal \\ \ba_{s2}^\intercal \end{bmatrix} \;.
\end{eqnarray}
Since $\mathbf{Q}$ is orthogonal, $\mathbf{Q}^\intercal$ projects the input vector to its column space. The square root of $\tilde{\Ga}$ is found by taking the square root of the eigenvalues in the diagonal matrix. Analogously, the wave extrapolation operator, $e^{i\Fi \Delta t}$, can be computed as:
\begin{eqnarray}
\label{eq:sqrt}
&e^{i\Fi \Delta t} = \\ \nonumber
&\begin{bmatrix} \ba_p & \ba_{s1} & \ba_{s2}\end{bmatrix} \begin{bmatrix} 
e^{i v_p k \Delta t} & 0 & 0 \\ 
0 & e^{i v_{s1} k \Delta t} & 0 
\\ 0 & 0 & e^{i v_{s2} k \Delta t} 
\end{bmatrix} 
\begin{bmatrix} \ba_p^\intercal \\ \ba_{s1}^\intercal \\ \ba_{s2}^\intercal \end{bmatrix} \;.
\end{eqnarray}
An analogous idea of using matrix exponentials for wave propagation was studied previously by \cite{kosloff87} in application to the one-way wave equation. Physically, the operator in equation~\ref{eq:sqrt} first decomposes the input vector wavefield into three wave modes, phase shifts them using the corresponding phase velocities, and then aligns them in the polarization directions of the decomposed wave modes. The operator defined in equation~\ref{eq:sqrt} can be expressed as a summation of rank-one matrices
\begin{equation}
\label{eq:rankone}
e^{i\Fi \Delta t} = \sum\limits_{i=p,s1,s2} e^{i v_i k \Delta t} \ba_i \ba_i^\intercal \; .
\end{equation}
Note that $\ba_i \ba_i^\intercal$ term in equation~\ref{eq:rankone} is the wave mode decomposition operator \cite[]{joethesis,zm}.

In 3D, we can transform the input vector in the wavenumber domain $\hat{\uu}(k) = \begin{bmatrix} \hat{u}_x(k) & \hat{u}_y(k) & \hat{u}_z(k) \end{bmatrix}^\intercal$. To apply the Fourier integral operator, we omit the pair of forward and backward Fourier transforms and formally write
\begin{eqnarray}
    \label{eq:osop}
%\int e^{-ix \cdot k}  dk
e^{i\Fi \Delta t} \hat{\uu}(k) =&
\sum\limits_{i=p,s1,s2} e^{i v_i k \Delta t} \ba_i \ba_i^\intercal \hat{\uu} \\ \nonumber
=& \begin{bmatrix} \ba_p & \ba_{s1} & \ba_{s2}\end{bmatrix} 
\begin{bmatrix} 
e^{i v_p k \Delta t} & 0 & 0 \\ 
0 & e^{i v_{s1} k \Delta t} & 0 \\ 
0 & 0 & e^{i v_{s2} k \Delta t} 
\end{bmatrix} 
\begin{bmatrix} \ba_p^\intercal \\ \ba_{s1}^\intercal \\ \ba_{s2}^\intercal \end{bmatrix} \hat{\uu} \\ \nonumber
%=& \; e^{i v_p k \Delta t} \, (a_{p_x} \hat{u}_x + a_{p_y} \hat{u}_y + a_{p_z} \hat{u}_z) \, \ba_{p} + \\ \nonumber
%&\; e^{i v_{s1} k \Delta t} \, (a_{s1_x} \hat{u}_x + a_{s1_y} \hat{u}_y + a_{s1_z} \hat{u}_z) \, \ba_{s1} + \\ \nonumber
%&\; e^{i v_{s2} k \Delta t} \, (a_{s2_x} \hat{u}_x + a_{s2_y} \hat{u}_y + a_{s2_z} \hat{u}_z) \, \ba_{s2} \\ \nonumber
=& \begin{bmatrix}
s_{xx} & s_{xy} & s_{xz} \\
s_{yx} & s_{yy} & s_{yz} \\
s_{zx} & s_{zy} & s_{zz} \\
\end{bmatrix} \hat{\uu} \;,
\end{eqnarray}
where
\begin{eqnarray}
    \label{eq:exps}
s_{xx} =& e^{i v_p k \Delta t} a_{p_x} a_{p_x} + e^{i v_{s1} k \Delta t} a_{s1_x} a_{s1_x} + e^{i v_{s2} k \Delta t} a_{s2_x} a_{s2_x} \;, \\ \nonumber
s_{xy} =& e^{i v_p k \Delta t} a_{p_x} a_{p_y} + e^{i v_{s1} k \Delta t} a_{s1_x} a_{s1_y} + e^{i v_{s2} k \Delta t} a_{s2_x} a_{s2_y} \;, \\ \nonumber
s_{xz} =& e^{i v_p k \Delta t} a_{p_x} a_{p_z} + e^{i v_{s1} k \Delta t} a_{s1_x} a_{s1_z} + e^{i v_{s2} k \Delta t} a_{s2_x} a_{s2_z} \;, \\ \nonumber
s_{yy} =& e^{i v_p k \Delta t} a_{p_y} a_{p_y} + e^{i v_{s1} k \Delta t} a_{s1_y} a_{s1_y} + e^{i v_{s2} k \Delta t} a_{s2_y} a_{s2_y} \;, \\ \nonumber
s_{yz} =& e^{i v_p k \Delta t} a_{p_y} a_{p_z} + e^{i v_{s1} k \Delta t} a_{s1_y} a_{s1_z} + e^{i v_{s2} k \Delta t} a_{s2_y} a_{s2_z} \;, \\ \nonumber
s_{zz} =& e^{i v_p k \Delta t} a_{p_z} a_{p_z} + e^{i v_{s1} k \Delta t} a_{s1_z} a_{s1_z} + e^{i v_{s2} k \Delta t} a_{s2_z} a_{s2_z} \;, \\ \nonumber
s_{yx} =& s_{xy} \;,\; s_{zx} = s_{xz} \;,\; s_{zy} = s_{yz} \;.
\end{eqnarray}

Using the form of equation~\ref{eq:os}, we can also define the backward time extrapolator
\begin{equation}
\label{eq:os-b}
\hat{\uu}(\x,t-\Delta t) = e^{-i\Fi\Delta t} \hat{\uu}(\x,t) \;.
\end{equation}
If we require the data to be real-valued at every time step, and sum the forward and backward extrapolators, we arrive at the two-step formulation:
\begin{equation}
\label{eq:ts}
\hat{\uu} (\x,t+\Delta t) = 2\,\cos(\Fi \Delta t) \hat{\uu}(\x,t) - \hat{\uu}(\x,t-\Delta t) \;.
\end{equation}
According to equation~\ref{eq:rankone}, the cosine term has the following interpretation:
\begin{eqnarray}
    \label{eq:euler}
\cos(\Fi \Delta t) =& e^{i\Fi\Delta t} + e^{-i\Fi\Delta t} \\ \nonumber 
=& \sum\limits_{i=p,s1,s2} (e^{i v_i k \Delta t} + e^{-i v_i k \Delta t}) \ba_i \ba_i^\intercal \\ \nonumber
=& \sum\limits_{i=p,s1,s2} 2\,\cos(v_i k \Delta t) \ba_i \ba_i^\intercal \;,
\end{eqnarray}
and can be calculated as
\begin{eqnarray}
    \label{eq:twostep}
\cos(\Fi \Delta t) \hat{\uu}(k) = &
\begin{bmatrix}
c_{xx} & c_{xy} & c_{xz} \\
c_{yx} & c_{yy} & c_{yz} \\
c_{zx} & c_{zy} & c_{zz} \\
\end{bmatrix} \hat{\uu} \;.
\end{eqnarray}
where
\begin{eqnarray}
    \label{eq:cosines}
c_{xx} =& \cos(v_p k \Delta t) a_{p_x} a_{p_x} + \cos(v_{s1} k \Delta t) a_{s1_x} a_{s1_x} + \cos(v_{s2} k \Delta t) a_{s2_x} a_{s2_x} \;, \\ \nonumber
c_{xy} =& \cos(v_p k \Delta t) a_{p_x} a_{p_y} + \cos(v_{s1} k \Delta t) a_{s1_x} a_{s1_y} + \cos(v_{s2} k \Delta t) a_{s2_x} a_{s2_y} \;, \\ \nonumber
c_{xz} =& \cos(v_p k \Delta t) a_{p_x} a_{p_z} + \cos(v_{s1} k \Delta t) a_{s1_x} a_{s1_z} + \cos(v_{s2} k \Delta t) a_{s2_x} a_{s2_z} \;, \\ \nonumber
c_{yy} =& \cos(v_p k \Delta t) a_{p_y} a_{p_y} + \cos(v_{s1} k \Delta t) a_{s1_y} a_{s1_y} + \cos(v_{s2} k \Delta t) a_{s2_y} a_{s2_y} \;, \\ \nonumber
c_{yz} =& \cos(v_p k \Delta t) a_{p_y} a_{p_z} + \cos(v_{s1} k \Delta t) a_{s1_y} a_{s1_z} + \cos(v_{s2} k \Delta t) a_{s2_y} a_{s2_z} \;, \\ \nonumber
c_{zz} =& \cos(v_p k \Delta t) a_{p_z} a_{p_z} + \cos(v_{s1} k \Delta t) a_{s1_z} a_{s1_z} + \cos(v_{s2} k \Delta t) a_{s2_z} a_{s2_z} \;, \\ \nonumber
c_{yx} =& c_{xy} \;,\; c_{zx} = c_{xz} \;,\; c_{zy} = c_{yz} \;.
\end{eqnarray}
Note that, because the elements of the $3\times3$ matrix $\cos(\Fi \Delta t)$ in equation~\ref{eq:twostep} are real-valued, the wavefield can stay real-valued as well. The matrix $\cos(\Fi \Delta t)$ is also closely connected with the k-space adjustment of the Christoffel matrix \cite[]{liu95,firouzi12,cheng16}. 

Expanding the wave extrapolation operator in the form of equations~\ref{eq:exps} and \ref{eq:cosines} reveals a simple relationship between wave propagation and wave mode decomposition. In the one-step formulation, each individual term contained in each element of $e^{i\Fi \Delta t}$ is essentially a sequence of wave-mode decomposition, phase shift and recomposition. For example, the action of the first term in $s_{xx}$, $e^{i v_p k \Delta t} a_{p_x} a_{p_x}$, can be interpreted as projecting the x-component of a vector elastic wavefield onto the P-wave mode, phase shifting it using the P-wave phase velocity and then aligning it with the x-component of the P-wave polarization direction. If individual wave modes are needed to perform imaging, the decoupled operators can be separately applied. The operators concerning a specific wave mode are indicated by the corresponding phase velocity. The first columns in equations~\ref{eq:exps} and \ref{eq:cosines} are P-wave propagators, while the second and third columns are $S1$ and $S2$ wave propagators, respectively. In general anisotropic media beyond tilted transverse isotropic (TTI) symmetry, the two S-wave modes do not decouple easily. Therefore, in order to avoid S-wave singularities in wave propagation, the two coupled S-waves should be computed together \cite[]{sun16,cheng16}.

The proposed framework, however, does not require explicit wave mode decomposition for wave extrapolation. Therefore, it can significantly reduce the computational cost of wave extrapolation, yet still obtain waves free of instability and dispersion artifacts. We also emphasize that the proposed method is capable of handling general anisotropic media, including the case of triclinic anisotropy.

\subsection{Heterogeneous media}
In heterogeneous media, the elastic wave equation can be expressed using the Einstein notation:
\begin{equation}
    \rho \ddot{u}_i = (c_{ijkl} u_{k,l})_{,j} = c_{ijkl} u_{k,lj} + c_{ijkl,j} u_{k,l} \;,
\end{equation}
where dot on top denotes time derivative, comma in subscript denotes spatial derivative and repeated indices imply summation. Analogously, the Christoffel matrix $\Gamma$ in the case of orthorhombic symmetry can be expanded using the chain rule
\begin{eqnarray}
    \Gamma 
    &= \D \C(\mathbf{x}) \D^\intercal \\ \nonumber
    &= 
    \begin{bmatrix}
        \partial_x & 0 & 0 & 0 & \partial_z & \partial_y \\
        0 & \partial_y & 0 & \partial_z & 0 & \partial_x \\
        0 & 0 & \partial_z & \partial_y & \partial_x & 0
    \end{bmatrix}
    \begin{bmatrix}
        C_{11} & C_{12} & C_{13} & 0 & 0 & 0                \\
        C_{12} & C_{22} & C_{23} & 0 & 0 & 0                \\
        C_{13} & C_{23} & C_{33} & 0 & 0 & 0                \\
        0      & 0      & 0      & C_{44} & 0      & 0      \\
        0      & 0      & 0      & 0      & C_{55} & 0      \\
        0      & 0      & 0      & 0      & 0      & C_{66}
    \end{bmatrix}
    \begin{bmatrix}
        \partial_x & 0 & 0\\
        0 & \partial_y & 0\\
        0 & 0 & \partial_z\\
        0 & \partial_z & \partial_y\\
        \partial_z & 0 & \partial_x\\
        \partial_y & \partial_x & 0
    \end{bmatrix} \\ \nonumber
    &=
    \begin{bmatrix}
        \partial_x & 0 & 0 & 0 & \partial_z & \partial_y \\
        0 & \partial_y & 0 & \partial_z & 0 & \partial_x \\
        0 & 0 & \partial_z & \partial_y & \partial_x & 0
    \end{bmatrix}
    \begin{bmatrix}
        C_{11}\partial_x & C_{12}\partial_y & C_{13}\partial_z \\
        C_{12}\partial_x & C_{22}\partial_y & C_{23}\partial_z \\
        C_{13}\partial_x & C_{23}\partial_y & C_{33}\partial_z \\
        0                & C_{44}\partial_z & C_{44}\partial_y \\
        C_{55}\partial_z & 0                & C_{55}\partial_x \\
        C_{66}\partial_y & C_{66}\partial_x & 0      
    \end{bmatrix} \\ \nonumber
    &=
    \begin{bmatrix}
        C_{11}\partial_x^2+C_{66}\partial_y^2+C_{55}\partial_z^2 & (C_{12}+C_{66})\partial_x\partial_y & (C_{13}+C_{55})\partial_x\partial_z \\
        (C_{12}+C_{66})\partial_x\partial_y & C_{66}\partial_x^2+C_{22}\partial_y^2+C_{44}\partial_z^2 & (C_{23}+C_{44})\partial_y\partial_z  \\
        (C_{13}+C_{55})\partial_x\partial_z & (C_{23}+C_{44})\partial_y\partial_z & C_{55}\partial_x^2+C_{44}\partial_y^2+C_{33}\partial_z^2
    \end{bmatrix} + \\ \nonumber
    &\ \hphantom{=}
    \begin{bmatrix}
        \partial_xC_{11}\partial_x+\partial_yC_{66}\partial_y+\partial_zC_{55}\partial_z & \partial_xC_{12}\partial_y+\partial_yC_{66}\partial_x & \partial_xC_{13}\partial_z+\partial_zC_{55}\partial_x \\
        \partial_yC_{12}\partial_x+\partial_xC_{66}\partial_y & \partial_xC_{66}\partial_x+\partial_yC_{22}\partial_y+\partial_zC_{44}\partial_z & \partial_yC_{23}\partial_z+\partial_zC_{44}\partial_y \\
        \partial_zC_{13}\partial_x+\partial_xC_{55}\partial_z & \partial_zC_{23}\partial_y+\partial_yC_{44}\partial_z & \partial_xC_{55}\partial_x+\partial_yC_{44}\partial_y+\partial_zC_{33}\partial_z
    \end{bmatrix}
    \;.
\end{eqnarray}

After spatial Fourier transform, $-\Ga \xrightarrow{\mathscr{F}} \tilde{\Ga}$. The Christoffel matrix $\tilde{\Ga}$ in the case of orthorhombic anisotropy takes the form:
\begin{eqnarray}
  \tilde{\Ga} 
  &=
  \begin{bmatrix}
    C_{11}k_x^2+C_{66}k_y^2+C_{55}k_z^2 & (C_{12}+C_{66})k_xk_y & (C_{13}+C_{55})k_xk_z \\
    (C_{12}+C_{66})k_xk_y & C_{66}k_x^2+C_{22}k_y^2+C_{44}k_z^2 & (C_{23}+C_{44})k_yk_z  \\
    (C_{13}+C_{55})k_xk_z & (C_{23}+C_{44})k_yk_z & C_{55}k_x^2+C_{44}k_y^2+C_{33}k_z^2
  \end{bmatrix} - \\ \nonumber
  &\ \hphantom{=} i
  \begin{bmatrix}
      \partial_xC_{11}k_x+\partial_yC_{66}k_y+\partial_zC_{55}k_z & \partial_xC_{12}k_y+\partial_yC_{66}k_x & \partial_xC_{13}k_z+\partial_zC_{55}k_x \\
      \partial_yC_{12}k_x+\partial_xC_{66}k_y & \partial_xC_{66}k_x+\partial_yC_{22}k_y+\partial_zC_{44}k_z & \partial_yC_{23}k_z+\partial_zC_{44}k_y \\
      \partial_zC_{13}k_x+\partial_xC_{55}k_z & \partial_zC_{23}k_y+\partial_yC_{44}k_z & \partial_xC_{55}k_x+\partial_yC_{44}k_y+\partial_zC_{33}k_z
  \end{bmatrix}
  \;. 
\end{eqnarray}

When the model is smoothly varying, which is the underlying assumption of wave mode separation \cite[]{cheng14}, the gradients of stiffnesses are insignificant. In such cases, the imaginary matrix can be dropped, which leads to the conventional real-valued Christoffel matrix in Equation~\ref{eq:chris}. However, in the case of strong heterogeneity, such as at medium interfaces, the gradients of stiffnesses become significant and the imaginary part needs to be taken into account. Because $\tilde{\Ga}$ becomes complex and non-Hermitian, the eigendecomposition of the generic matrix $\A$ is expressed as
\begin{eqnarray}
\A = \frac{\tilde{\Ga}}{\rho} =& \mathbf{Q} \mathbf{V} \mathbf{Q}^{-1} \\ \nonumber 
=& \begin{bmatrix} \ba_1 & \ba_2 & \ba_3\end{bmatrix} \begin{bmatrix} \nu_1^2 & 0 & 0 \\ 0 & \nu_2^2 & 0 \\ 0 & 0 & \nu_3^2 \end{bmatrix} \begin{bmatrix} \hat{\ba}_1^* \\ \hat{\ba}_2^* \\ \hat{\ba}_3^* \end{bmatrix} \;,
\end{eqnarray}
where the superscript $*$ denotes conjugate transpose. Note that the eigenvalues $\nu_1^2\,,\nu_2^2$ and $\nu_3^2$, as well as their corresponding eigenvectors, are complex-valued. Since $\mathbf{Q}$ is square and $\mathbf{Q}^{-1} \mathbf{Q} = \mathbf{I}$:
\begin{eqnarray}
    \begin{cases}
        & \hat{\ba_i}^* \ba_j = 1 \;, i = j \;; \\ \nonumber
        & \hat{\ba_i}^* \ba_j = 0 \;, i \neq j \;.
    \end{cases}
\end{eqnarray}

Physically, this means in strongly heterogeneous media, wave mode separation cannot be clearly defined due to wave mode conversion, which is expressed as the imaginary part of eigenvalues. The polarization directions are no longer orthogonal in the real sense -- they become orthogonal complex vectors.

The situation stated above does not prevent our framework from performing the correct wavefield extrapolation. The wave extrapolation operator then becomes
\begin{eqnarray}
    \label{eq:osop2}
e^{i\Fi \Delta t} \hat{\uu}(k) =&
\sum\limits_{i=1,2,3} e^{i \nu_i \Delta t} \ba_i \hat{\ba}_i^* \hat{\uu} \\ \nonumber
=& \begin{bmatrix} \ba_1 & \ba_2 & \ba_3 \end{bmatrix} 
\begin{bmatrix} 
e^{i \nu_1 \Delta t} & 0 & 0 \\ 
0 & e^{i \nu_2 \Delta t} & 0 \\ 
0 & 0 & e^{i \nu_3 \Delta t} 
\end{bmatrix} 
\begin{bmatrix} \hat{\ba}_1^* \\ \hat{\ba}_2^* \\ \hat{\ba}_3^* \end{bmatrix} \hat{\uu} \\ \nonumber
=& \begin{bmatrix}
    \hat{s}_{xx} & \hat{s}_{xy} & \hat{s}_{xz} \\
    \hat{s}_{yx} & \hat{s}_{yy} & \hat{s}_{yz} \\
    \hat{s}_{zx} & \hat{s}_{zy} & \hat{s}_{zz} \\
\end{bmatrix} \hat{\uu} \;,
\end{eqnarray}
where
\begin{eqnarray}
    \label{eq:exps2}
    \hat{s}_{xx} =& e^{i \nu_1 \Delta t} a_{1_x} \hat{a}_{1_x} + e^{i \nu_2 \Delta t} a_{2_x} \hat{a}_{2_x} + e^{i \nu_3 \Delta t} a_{3_x} \hat{a}_{3_x} \;, \\ \nonumber
    \hat{s}_{xy} =& e^{i \nu_1 \Delta t} a_{1_x} \hat{a}_{1_y} + e^{i \nu_2 \Delta t} a_{2_x} \hat{a}_{2_y} + e^{i \nu_3 \Delta t} a_{3_x} \hat{a}_{3_y} \;, \\ \nonumber
    \hat{s}_{xz} =& e^{i \nu_1 \Delta t} a_{1_x} \hat{a}_{1_z} + e^{i \nu_2 \Delta t} a_{2_x} \hat{a}_{2_z} + e^{i \nu_3 \Delta t} a_{3_x} \hat{a}_{3_z} \;, \\ \nonumber
    \hat{s}_{yx} =& e^{i \nu_1 \Delta t} a_{1_y} \hat{a}_{1_x} + e^{i \nu_2 \Delta t} a_{2_y} \hat{a}_{2_x} + e^{i \nu_3 \Delta t} a_{3_y} \hat{a}_{3_x} \;, \\ \nonumber
    \hat{s}_{yy} =& e^{i \nu_1 \Delta t} a_{1_y} \hat{a}_{1_y} + e^{i \nu_2 \Delta t} a_{2_y} \hat{a}_{2_y} + e^{i \nu_3 \Delta t} a_{3_y} \hat{a}_{3_y} \;, \\ \nonumber
    \hat{s}_{yz} =& e^{i \nu_1 \Delta t} a_{1_y} \hat{a}_{1_z} + e^{i \nu_2 \Delta t} a_{2_y} \hat{a}_{2_z} + e^{i \nu_3 \Delta t} a_{3_y} \hat{a}_{3_z} \;, \\ \nonumber
    \hat{s}_{zx} =& e^{i \nu_1 \Delta t} a_{1_z} \hat{a}_{1_x} + e^{i \nu_2 \Delta t} a_{2_z} \hat{a}_{2_x} + e^{i \nu_3 \Delta t} a_{3_z} \hat{a}_{3_x} \;, \\ \nonumber
    \hat{s}_{zy} =& e^{i \nu_1 \Delta t} a_{1_z} \hat{a}_{1_y} + e^{i \nu_2 \Delta t} a_{2_z} \hat{a}_{2_y} + e^{i \nu_3 \Delta t} a_{3_z} \hat{a}_{3_y} \;, \\ \nonumber
    \hat{s}_{zz} =& e^{i \nu_1 \Delta t} a_{1_z} \hat{a}_{1_z} + e^{i \nu_2 \Delta t} a_{2_z} \hat{a}_{2_z} + e^{i \nu_3 \Delta t} a_{3_z} \hat{a}_{3_z} \;.
\end{eqnarray}

Comparing equation~\ref{eq:osop2} with equation~\ref{eq:osop}, we can see that because the eigenvalues that appear in the exponent in equation~\ref{eq:osop2} are no longer real-valued, the corresponding two-step operators to that in equation~\ref{eq:euler} cannot be constructed using Euler's formula.

\subsection{Low-rank approximation}
So far, we have laid out our basic theory of recursive integral time extrapolation of elastic waves. In mildly heterogeneous media, the Christoffel matrix is SPD. In strongly heterogeneous media, the Christoffel matrix becomes complex-valued and non-Hermitian. However, in both cases, the eigenvalues and eigenvectors of the Christoffel matrix become dependent on both spatial location and propagation direction, in other words, they are functions of both space $\x$ and wavenumber $\kk$. If these operators are implemented straightforwardly, one is faced with the daunting task of computing and storing the complete eigenvalue decomposition of the Christoffel matrix using all the combinations of $\x$ and $\kk$, leading to $\mathcal{O}(N_x^2)$ computational and memory complexity, where $N_x$ refers to the total number of mesh points in $3$D. To perform wave extrapolation in the form of integral operators, one would have to multiply matrices with vectors in dimension of $N_x$, leading to a computational complexity of $\mathcal{O}(N_x^2)$. This is simply infeasible for practical applications.

In this work, to efficiently apply the derived Fourier Integral Operators (FIOs), we proposed to apply the low-rank decomposition \cite[]{lowrank} on the mixed-domain wave extrapolation matrices. Take the wave extrapolation operator in equation~\ref{eq:osop2}, $e^{i\Fi \Delta t}$, as an example. We propose to apply low-rank approximation on each individual element of its expansion. For instance, the $\hat{s}_{xx}$ element, which operates on the x-component of the input vector wavefield and outputs to the x-component of the output vector wavefield, can be approximated as \cite[]{lowrank}:
\begin{equation}
  \label{eq:lra}
  \hat{s}_{xx}(\mathbf{x},\mathbf{k})  \approx \sum\limits_{m=1}^M \sum\limits_{n=1}^N \hat{s}_{xx}(\mathbf{x},\mathbf{k}_m) a_{mn} \hat{s}_{xx}(\mathbf{x}_n,\mathbf{k})\;,
\end{equation}
where $\hat{s}_{xx}(\mathbf{x},\mathbf{k}_m)=\mathbf{U}$ and $\hat{s}_{xx}(\mathbf{x}_n,\mathbf{k})=\mathbf{V}^*$ are sampled representative columns and rows from the original matrix $\hat{s}_{xx}(\mathbf{x},\mathbf{k})=\mathbf{W}$, $M$ and $N$ are the numerical ranks of matrix $\mathbf{W}$, and the matrix $a_{mn}=\mathbf{A}$ is obtained from minimizing
\begin{equation}
\min_{\mathbf{A}} \lVert \mathbf{\mathbf{W} - \mathbf{U} \mathbf{A} \mathbf{V}^*} \rVert_F \;.
\end{equation}
Similarly, $\hat{s}_{xy}$ and $\hat{s}_{xz}$ can be approximated as:
\begin{eqnarray}
  \label{eq:lra2}
  \hat{s}_{xy}(\mathbf{x},\mathbf{k}) &\approx \sum\limits_{m=1}^M \sum\limits_{n=1}^N \hat{s}_{xy}(\mathbf{x},\mathbf{k}_m) b_{mn} \hat{s}_{xy}(\mathbf{x}_n,\mathbf{k})\;, \\
  \hat{s}_{xz}(\mathbf{x},\mathbf{k}) &\approx \sum\limits_{m=1}^M \sum\limits_{n=1}^N \hat{s}_{xz}(\mathbf{x},\mathbf{k}_m) c_{mn} \hat{s}_{xz}(\mathbf{x}_n,\mathbf{k})\;.
\end{eqnarray}
The computation of $\hat{u}_x(\mathbf{x},t+\Delta t)$ then becomes:
\begin{eqnarray}
    \label{eq:timestep}
    \hat{u}_x(\mathbf{x},t+\Delta t) 
    \approx & \sum\limits_{m=1}^M \hat{s}_{xx}(\mathbf{x},\mathbf{k}_m) \left( \sum\limits_{n=1}^N a_{mn} \left(\int e^{i \mathbf{x}\mathbf{k}} \hat{s}_{xx}(\mathbf{x}_n,\mathbf{k}) \hat{u}_x(\mathbf{k},t) d\mathbf{k} \right) \right) \\ \nonumber
    +       & \sum\limits_{m=1}^M \hat{s}_{xy}(\mathbf{x},\mathbf{k}_m) \left( \sum\limits_{n=1}^N b_{mn} \left(\int e^{i \mathbf{x}\mathbf{k}} \hat{s}_{xy}(\mathbf{x}_n,\mathbf{k}) \hat{u}_y(\mathbf{k},t) d\mathbf{k} \right) \right) \\ \nonumber
    +       & \sum\limits_{m=1}^M \hat{s}_{xz}(\mathbf{x},\mathbf{k}_m) \left( \sum\limits_{n=1}^N c_{mn} \left(\int e^{i \mathbf{x}\mathbf{k}} \hat{s}_{xz}(\mathbf{x}_n,\mathbf{k}) \hat{u}_z(\mathbf{k},t) d\mathbf{k} \right) \right) \;.
\end{eqnarray}
The computation of $y$ and $z$ components can be carried out in a similar fashion. The computational cost of applying each FIO reduces to a complexity of $\mathcal{O}(N N_x \log N_x)$, where $\mathcal{O}(N_x \log N_x)$ is the complexity of one forward or inverse Fast Fourier Transform (FFT), and $N$ is the numerical rank of the low-rank approximation, which is $1$ for homogeneous media and $\mathcal{O}(1)$ for heterogeneous media.

\subsection{Energy-norm imaging condition}
The proposed method is well-suited for applications to elastic imaging and inversion using multi-component seismic data. In this section, we derive the energy-norm imaging condition using analytical wavefield, and show its connection to wave-mode decomposition.

The energy norm with respect to a SPD matrix $\MM$ can be defined as:
\begin{equation}
    \label{eq:e-norm}
    e^2(\uu) = ||\uu||_{\MM} = \uu^\intercal \MM \uu \;.
\end{equation}
In the acoustic case, the imaging condition based on the energy-norm is also referred to as the impedance sensitivity kernal \cite[]{zhu09} or the inverse scattering imaging condition \cite[]{whitmore12}:
\begin{equation}
    \label{eq:enorm-acu}
    I_a = \rho \uu_t^\intercal \w_t + (v \nabla \uu)^\intercal (v \nabla \w) \;.
\end{equation}
For general elastic media, the energy norm imaging condition can be expressed as \cite[]{kiyashchenko07,rocha16}
\begin{equation}
    \label{eq:enorm-ela}
    I_e = \rho \uu_t^\intercal \w_t + \uu^\intercal \D\C\D^\intercal \w \;.
\end{equation}
Using the analytic wavefield, equation~\ref{eq:enorm-ela} becomes
\begin{equation}
    \label{eq:enorm-ela2}
    I_e = \rho ( \uu_t^\intercal \w_t + \uu^\intercal \A \w ) = \rho ( \uu_t^\intercal \w_t + \uu^\intercal \Fi^\intercal \Fi \w ) = \mathscr{R}\left[ \rho (\Fi \hat{\uu})^*(\Fi \hat{\w}) \right] \;,
\end{equation}
where $\mathscr{R}$ represents the operator of taking the real part. In a locally homogeneous medium, equation~\ref{eq:enorm-ela2} can be expressed as
\begin{equation}
    \label{eq:enorm-ela3}
    I_e = \mathscr{R}\left[ \mathscr{F}^{-1} \left[ \rho \hat{\uu}^* \A \hat{\w} \right] \right] \;,
\end{equation}
where $\mathscr{F}^{-1}$ represents inverse spatial Fourier transform. $\A$ is SPD and has the eigenvalue decomposition as equation~\ref{eq:chris-eigen}, and the part in the wavenumber domain of equation~\ref{eq:enorm-ela3} can be further expanded as
\begin{eqnarray}
    \label{eq:decom-ic}
    \nonumber
    \rho \hat{\uu}^* \A \hat{\w} =& \rho  \left( \mathbf{Q}^\intercal \hat{\uu} \right)^* \mathbf{V} \mathbf{Q}^\intercal \hat{\w} \\ \nonumber
                                =& \begin{bmatrix} \hat{\uu}_p^* & \hat{\uu}_{s1}^* & \hat{\uu}_{s2}^*\end{bmatrix} \begin{bmatrix} v_p^2 k^2 & 0 & 0 \\ 0 & v_{s1}^2 k^2 & 0 \\ 0 & 0 & v_{s2}^2 k^2 \end{bmatrix} \begin{bmatrix} \hat{\w}_p \\ \hat{\w}_{s1} \\ \hat{\w}_{s2} \end{bmatrix} \\
                                =& \sum\limits_{i=p,s1,s2} v_i^2 k^2 \hat{\uu}_i^* \hat{\w}_i \;.
\end{eqnarray}
Equation~\ref{eq:decom-ic} corresponds to the summation of the image produced by three pure wave-mode reflections (P-P, S1-S1 and S2-S2 images) using the formula prescribed in equations~\ref{eq:enorm-acu}. Therefore, the proposed framework provides the possibility of individually accessing the contribution of each wave-mode in the elastic energy-norm imaging condition, in addition to outputing their summation.

The imaging condition prescribed in equation~\ref{eq:enorm-ela3} is the cross-correlation of two positive-frequency analytical wavefields. This corresponds to the back-scattering part of the wavefield. If one instead performs cross-correlation between two wavefield with opposite signs of frequency, e.g. $\uu^*$ only contains negative frequency and $\w$ only contains positive frequency, it will lead to a different forward-scattering imaging condition
\begin{equation}
    \label{eq:tomo-ela}
    I_t = \mathscr{R}\left[ \mathscr{F}^{-1} \left[ \rho \hat{\uu} \A \hat{\w} \right] \right] = \rho ( -\uu_t^\intercal \w_t + \uu^\intercal \A \w ) \;.
\end{equation}
The forward-scattering imaging condition corresponds to the tomographic correlation between two wavefields. It is conventionally treated as low-frequency noise in RTM, but is what FWI needs for performing low-frequency updates in the velocity gradient \cite{diaz12,diaz13,ramos16}. Equation~\ref{eq:tomo-ela} can also be expanded in a similar fashion as equation~\ref{eq:decom-ic} to access individual contributions from each wave mode.

It is important to note that the inverse- and forward-scattering imaging conditions using scalar and vector analytical wavefields discussed in this section are not restricted to one-step wave extrapolation. There are different ways of obtaining an analytical wavefield using conventional finite-different or pseudo-spectral wave extrapolation, for example, by separately propagating a wavefield using a Hilbert-transformed source wavelet \cite[]{shen15,hu16} and use it as the imaginary part of the analytical wavefield.

\begin{comment}
\subsection{Attenuation}
One key advantage of the one-step scheme (equation~\ref{eq:os}) is that attenuation can be directly incorporated into the diagonal matrix of eigenvalues, by simply modifying the phase velocity and adding an amplitude decay term. The reasoning follows from a complex stiffness tensor $\widehat{\C} = \C + i\mathbf{M}$.
\end{comment}

\section{Numerical examples}
In this section, we use various synthetic models to test the one-step version of the proposed low-rank RITE method.

\inputdir{twolayer3d}
\multiplot{2}{ORTw-fd-1,ORTw-ps-1}{width=0.45\textwidth}{Wavefield snapshot of wavefield propagation in a two-layer orthorhombic model using the finite-difference method (a) and the pseudospectral method (b) with a step size of $1\;ms$.}
\multiplot{4}{ORTw-lr-1,ORTw-lr-2,ORTw-lr-4,ORTw-lr-8}{width=0.45\textwidth} {Wavefield snapshot of wavefield propagation in a two-layer orthorhombic model using the proposed low-rank RITE method with a step size of $1\;ms$ (a), $2\;ms$ (b), $4\;ms$ (c) and $8\;ms$ (d). \label{fig:ritewave}}

We first test the accuracy and stability of the proposed method in a two-layer orthorhombic model, and compare it with the conventional finite-difference and pseudospectral methods. We construct a two-layer orthorhombic model on a $100\times100\times100$ grid with the density-normalized stiffness tensor (in $km^2/s^2$) of the first layer given in equation~\ref{eq:orth} \cite[]{schoenberg97}, and the second layer being a scaled version of the first layer by a factor of $1.8$. We apply triangle smoothing in the vertical direction with a radius of $4$. The spatial sampling rate in all directions of the grid is $10\;m$. A displacement source is oriented at $45^{\circ}$ tilt and $45^{\circ}$ azimuth and injected at $x=0.5\;km,\;y=0.5\;km\;,z=0.4\;km$. The source wavelet has a peak frequency of $35\;Hz$. A wavefield snapshot shown in Figure~\ref{fig:ritewave} was taken at $0.18\;s$. The wavefield that was modeled by eighth-order finite-difference in space and second-order finite-difference in time using a time-step size of $1\;ms$ suffers from strong dispersion artifacts (Figure~\ref{fig:ORTw-fd-1}), while the wavefield modeled by pseudospectral method in space and second-order finite-difference in time is free of spatial dispersions. However, increasing the time step size to $2\;ms$ leads to numerical instability of both methods, and thus the results are not shown. In comparison, the proposed low-rank RITE method shows an accurate result free from dispersion and instability using increasing time step sizes of $1\;ms$, $2\;ms$, $4\;ms$ and $8\;ms$ (Figure~\ref{fig:ritewave}).
\begin{equation}
\label{eq:orth}
\begin{bmatrix}
  9    & 3.6  & 2.25   & 0 & 0   & 0 \\
  3.6  & 9.84 & 2.4    & 0 & 0   & 0 \\
  2.25 & 2.4  & 5.9375 & 0 & 0   & 0 \\
  0    & 0    & 0      & 2 & 0   & 0 \\
  0    & 0    & 0      & 0 & 1.6 & 0 \\
  0    & 0    & 0      & 0 & 0   & 2.182
\end{bmatrix}
\end{equation}

\inputdir{gradient}
\multiplot{2}{ORTw-lr-1,ORTw-lr0-1}{width=0.45\textwidth}{Wavefield snapshot of wavefield propagation in a two-layer orthorhombic model using the low-rank RITE method with (a) and without (b) accounting for the gradient of stiffnesses. \label{fig:ritewave}}
\multiplot{3}{inter-lr,inter-ps,inter-pslr}{width=0.45\textwidth}{Interleaved shot gathers extracted at $Z=100\;m$ between wavefield modeled by (a) the low-rank method with and without including the stiffness gradient terms; (b) the pseudo-spectral method with and without including the stiffness gradient terms; and (c) the pseudo-spectral method and the low-rank method, both including the stiffness gradient terms. The odd-numbered traces correspond to the methods mentioned first. \label{fig:interleaved}}

Next, to test wave extrapolation accuracy at a medium interface, where strong heterogeneity occurs, we use the same two-layer orthorhombic model without smoothing in the vertical direction. Figure~\ref{fig:ritewave} shows wavefield snapshots taken at $t=0.18\;s$. Because of the strong contrast at the medium interface, the transmitted and reflected waves calculated by the proposed method including the stiffness gradient terms demonstrates noticeable amplitude and phase differences compared with the waves calculated by ignoring the gradient terms. Figure~\ref{fig:inter-lr} shows interleaved shot gathers extracted at $Z=100\;m$, which compares the modeled data by the low-rank method and the pseudo-spectral method, both with and without accounting for the stiffness gradient terms. We can observe that for either the low-rank or the pseudo-spectral methods, modeled direct P- and S-arrivals are identical while reflected P- and S-arrivals show obvious difference in both amplitude and phase due to the missing of stiffness gradient terms. To validate our observation, we also carry out wave extrapolation using the pseudo-spectral method by solving first- and second-order elastic wave equations. Their shot gather, shown in Figure~\ref{fig:inter-ps}, demonstrates the same phenomena. Finally, in Figure~\ref{fig:inter-pslr}, we interleave the amplitude-normalized shot gathers from low-rank RITE solution including the stiffness gradients, togethr with a pseudo-spectral solution of the first-order equations. They demonstrate almost identical amplitude and phase behavior. In terms of computational cost, the numerical ranks of the wave extrapolation matrices are $2$ when the stiffness gradient terms are not included, while the ranks increase to $5$ when the gradient terms are included.

\inputdir{homotric3d-dc}
\multiplot{2}{TRIw-lr-p,TRIw-lr-s}{width=0.45\textwidth}{Wavefield snapshot of (a) P-wave and (b) coupled S-waves propagation in a perturbed triclinic model using the proposed low-rank RITE method with a step size of $1\;ms$. \label{fig:tric}}

In the third example, we test the ability of the proposed method to model decomposed wave mode propagation in a more general anisotropic medium, a triclinic medium. We use the lab measurements from \cite{mah03} as the background model, with the stiffness tensors (in GPa) of the triclinic model shown in equation~\ref{eq:tric}, which is then normalized by a mass density of $1.395\;kg/m^3$. We then add spherical perturbations centered at $Z=400\;m, X=500\;m, Y=500\;m$ to all the density normalized stiffness tensors to make the models mildly heterogeneous. Using the same mesh size as the previous example, and a time step size of $1\;ms$, the proposed method is capable of accurately and separately propagating P- and S-waves in the triclinic medium (Figure~\ref{fig:tric}) using equation~\ref{eq:osop}. The two S-wave modes are propagated together since they do not decouple easily. Both the P- and coupled S-waves are free of numerical dispersion and instablity. The numercial ranks of the wave extrapolation matrices for this test are $3$.

%\begin{equation}
%\label{eq:mono}
%\begin{bmatrix}
%  15.5 & 7.0  & 6.4  & 0   & 0.3 & 0 \\
%  7.0  & 15.6 & 6.8  & 0   & 0.3 & 0 \\
%  6.4  & 6.8  & 10.9 & 0   & 0.3 & 0 \\
%  0    & 0    & 0    & 3.4 & 0.1 & 0 \\
%  0.3  & 0.3  & 0.3  & 0.1 & 3.0 & 0 \\
%  0    & 0    & 0    & 0   & 0   & 3.8
%\end{bmatrix}
%\end{equation}

\begin{equation}
\label{eq:tric}
\begin{bmatrix}
  14.9 & 6.3  & 5.2  & 0.7  & 0.9  & -0.5 \\
  6.3  & 14.9 & 5.7  & 0.8  & 1.5  & -0.4 \\
  5.2  & 5.7  & 10.0 & 0.7  & 0.8  & 0.1  \\
  0.7  & 0.8  & 0.7  & 3.3  & -0.1 & 0.1  \\
  0.9  & 1.5  & 0.8  & -0.1 & 3.0  & 0.2  \\
  -0.5 & -0.4 & 0.1  & 0.1  & 0.2  & 3.7
\end{bmatrix}
\end{equation}

\inputdir{french-dc}
\plot{ORTc-11-f}{width=0.45\textwidth}{(a) $C11$ of an orthorhommic model based on the French model.}
\multiplot{2}{ORTw-lr-p-x,snap-p-x-cut}{width=0.45\textwidth}{(a) The x-component of decoupled P-wavefield at $t=0.39s$. (b) A portion of the wavefield centered at $Z=0.64\;km, X=0.89\;m, Y=0.93\;m$.}
\multiplot{2}{freq-p-x,freq-p-x2}{width=0.45\textwidth}{Wavenumber amplitude spectrum of (a) the analytical wavefield, and (b) its real part.}
\multiplot{4}{snap-p-x-up,snap-s-x-up,snap-p-x-dn,snap-s-x-dn}{width=0.45\textwidth}{The decomposition of wavefield into up- and down-going directions. (a) The up-going P-wave, and (b) the up-going S-wave. (c) The down-going P-wave. (d) The down-going S-wave.}

In the last example, we demonstrate one advantage of the proposed method for seismic imaging applications, the accessibility of directional information of wavefield. For a real-valued wavefield, the propagation direction cannot be uniquely defined in the wavenumber domain because of its symmetric wavenumber spectrum about zero \cite[]{hu16}. This is due to the fact that the real-valued wavefield contains both positive and negative frequency components. The analytical wavefield, on the other hand, has decoupled positive and negative frequency components, so its wavenumber spectrum reveals the direction of wavefield propagation. To demonstrate this fact, we construct an orthorhombic model based on the French model \cite[]{frenchmodel}, with its $C11$ component shown in Figure~\ref{fig:ORTc-11-f}. We use equation~\ref{eq:osop} to calculate a decoupled P-wavefield, whose x-component at $t=0.39\;s$ is shown in Figure~\ref{fig:ORTw-lr-p-x}. We select a portion of the wavefield centered at $Z=0.4\;km, X=0.58\;m, Y=0.58\;m$ propagating in the direction negative along all three axes, as shown in Figure~\ref{fig:snap-p-x-cut}. Figure~\ref{fig:freq-p-x} shows the wavenumber amplitude spectrum of the wavefield, and its energy are all distributed in the positive octant. One the other hand, the wavenumber amplitude spectrum of the real part of the wavefield shows symmetric distribution of energy about the origin, as demonstrated by Figure~\ref{fig:freq-p-x2}. Finally, we decouple the upward-traveling and downward-traveling wavefield based on the sign $k_z$, and the downward-traveling P- and S-waves are shown in Figure~\ref{fig:snap-p-x-dn} and \ref{fig:snap-s-x-dn}.

\section{Discussion}
In this paper, we have considered second-order displacement equations for elastic wave extrapolation. However, the framework presented here is not limited to such a formulation. For example, second-order stress equations can be used, which has the advantage of not calculating spatial derivative of stiffnesses. Other first-order formulations should also be investigated. 

Our formulation can be viewed as an extension of the one-step extrapolation method by \cite{zhang09} to elastic anisotropic media. It has been shown by \cite{bleistein08} that the one-step solution is asymptotically true amplitude, i.e., it provides the same traveltime and leading order amplitude as conventional acoustic wave propagation. It is reasonable to expect that the new formulation for elastic waves has similar behavior. However, more rigorous theoretical proof is required to arrive at a definitive conclusion.

In the last numerical example, we have demonstrated that our method is advantageous in providing directional information about the wavefield. This allows for efficient computation of wavefield up-down separation, RTM angle gathers and absorbing boundary conditions \cite[]{shen15,hu16,me15b} in the context of elastic imaging.

\section{Conclusions}
We have presented a recursive integral time extrapolation method for modeling elastic wave propagation in general heterogeneous anisotropic media. The one-step formulation involves analytical wavefields that contain either positive or negative frequencies, which provides crucial information about the direction of wave propagation. The two-step formulation, on the other hand, involves only real-valued wavefields. The proposed method employs a low-rank approximation to efficiently apply the Fourier integral operators defined by the mixed-domain components of the modified Christoffel matrix. In practice, this reduces the computational cost to a small number of spatial fast Fourier transforms per time step. The low-rank decomposition only needs to be computed once prior to wave extrapolation. Numerical examples show that the proposed method has superior accuracy and stability compared with conventional finite-difference and pseudospectral methods. 

\section{Acknowledgements}
We thank Jiubing Cheng for helpful discussions and thank the sponsors of the Texas Consortium for Computational Seismology for financial support. The first and third authors were additionally supported by the Statoil Fellows Program at the University of Texas at Austin. We thank the Texas Advanced Computing Center for providing computational resources used in this study.

\bibliographystyle{seg}
\bibliography{elas}
